services:
  # --------------------------------------------------------------------------
  # INFRASTRUCTURE
  # --------------------------------------------------------------------------

  mongo:
    image: mongo:latest
    container_name: mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DB:-carpooling}
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
    volumes:
      - mongo_data:/data/db
    networks:
      - carpooling-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-users:
    image: mysql:8.0
    container_name: mysql-users
    restart: unless-stopped
    ports:
      - "3308:3306" # Puerto externo 3307, interno 3306
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_USERS_ROOT_PASSWORD:-rootpass_users}
      MYSQL_DATABASE: users_db
    volumes:
      - mysql_users_data:/var/lib/mysql
      - ./backend/users-api/scripts/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    networks:
      - carpooling-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5
  mysql-bookings:
    image: mysql:8.0
    container_name: mysql-bookings
    restart: unless-stopped
    ports:
      - "3307:3306" # Otro puerto externo diferente
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_BOOKINGS_ROOT_PASSWORD:-rootpass_bookings}
      MYSQL_DATABASE: bookings_db
    volumes:
      - mysql_bookings_data:/var/lib/mysql
    networks:
      - carpooling-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_BOOKINGS_ROOT_PASSWORD:-rootpass_bookings}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbit:
    image: rabbitmq:3-management
    container_name: rabbit
    restart: unless-stopped
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    volumes:
      - rabbit_data:/var/lib/rabbitmq
    networks:
      - carpooling-network
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  memcached:
    image: memcached:1.6-alpine
    container_name: memcached
    restart: unless-stopped
    command: [ "-m", "128" ]
    ports:
      - "11211:11211"
    networks:
      - carpooling-network

  solr:
    image: solr:9-slim
    container_name: solr
    restart: unless-stopped
    ports:
      - "8983:8983"
    environment:
      SOLR_HEAP: 512m
    volumes:
      - solr_data:/var/solr
    command: solr-precreate carpooling_trips
    networks:
      - carpooling-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8983/solr/admin/cores?action=STATUS" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 40s

  # --------------------------------------------------------------------------
  # MICROSERVICES
  # --------------------------------------------------------------------------

  users-api:
    build: ./backend/users-api
    container_name: users-api
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      SERVER_PORT: 8001
      DATABASE_URL_USERS: root:${MYSQL_USERS_ROOT_PASSWORD}@tcp(mysql-users:3306)/${DB_NAME_USERS}?charset=utf8mb4&parseTime=True&loc=Local
      JWT_SECRET: ${JWT_SECRET}
      TRIPS_API_URL: http://trips-api:8002
      ENVIRONMENT: ${ENVIRONMENT:-development}
      # SMTP Configuration for email verification
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_FROM: ${SMTP_FROM:-matiasjbocco@gmail.com}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      APP_URL: ${APP_URL}
    networks:
      - carpooling-network
    depends_on:
      mysql-users:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  trips-api:
    build: ./backend/trips-api
    container_name: trips-api
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      MONGO_URI_TRIPS: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongo:27017/carpooling?authSource=admin
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbit:5672/
      JWT_SECRET: ${JWT_SECRET}
      USERS_API_URL: http://users-api:8001
      PORT: 8002
      GIN_MODE: ${GIN_MODE:-debug}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - carpooling-network
    depends_on:
      mongo:
        condition: service_healthy
      rabbit:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  bookings-api:
    build: ./backend/bookings-api
    container_name: bookings-api
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      SERVER_PORT: 8003
      DATABASE_URL_BOOKINGS: root:${MYSQL_BOOKINGS_ROOT_PASSWORD}@tcp(mysql-bookings:3306)/${DB_NAME_BOOKINGS}?charset=utf8mb4&parseTime=True&loc=Local
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbit:5672/
      JWT_SECRET: ${JWT_SECRET}
      TRIPS_API_URL: http://trips-api:8002
      ENVIRONMENT: ${ENVIRONMENT:-development}
    networks:
      - carpooling-network
    depends_on:
      mysql-bookings:
        condition: service_healthy
      rabbit:
        condition: service_healthy
      trips-api:
        condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  search-api:
    build: ./backend/search-api
    container_name: search-api
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      SERVER_PORT: 8004
      MONGO_URI_SEARCH: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongo:27017/${MONGO_DB_SEARCH}?authSource=admin
      MONGO_DB_SEARCH: ${MONGO_DB_SEARCH}
      SOLR_URL: http://solr:8983/solr
      SOLR_CORE: carpooling_trips
      MEMCACHED_SERVERS: memcached:11211
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbit:5672/
      QUEUE_NAME: search.events
      USERS_API_URL: http://users-api:8001
      TRIPS_API_URL: http://trips-api:8002
      HTTP_TIMEOUT: 5s
      HTTP_MAX_RETRIES: 3
      JWT_SECRET: ${JWT_SECRET}
      GIN_MODE: ${GIN_MODE:-debug}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - carpooling-network
    depends_on:
      mongo:
        condition: service_healthy
      solr:
        condition: service_healthy
      memcached:
        condition: service_started
      rabbit:
        condition: service_healthy
      trips-api:
        condition: service_started
      users-api:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8004/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # --------------------------------------------------------------------------
  # FRONTEND
  # --------------------------------------------------------------------------

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_USERS_API_URL: http://localhost:8001
        VITE_TRIPS_API_URL: http://localhost:8002
        VITE_BOOKINGS_API_URL: http://localhost:8003
        VITE_SEARCH_API_URL: http://localhost:8004
    container_name: frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    networks:
      - carpooling-network
    depends_on:
      users-api:
        condition: service_started
      trips-api:
        condition: service_started
      bookings-api:
        condition: service_started
      search-api:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  carpooling-network:
    driver: bridge
    name: carpooling-network
# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  mongo_data:
  mysql_users_data:
  mysql_bookings_data:
  rabbit_data:
  solr_data:
